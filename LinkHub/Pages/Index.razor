@page "/"
@using LinkHubApp.Models
@inject AuthenticationStateProvider AuthStateProvider

<!--
    Glance Bookmark main page
    - Add bookmarks, add categories, search/filter, and display link list
-->

<h3>Glance Bookmark</h3>

<!-- Input form: Add a new bookmark -->
<div class="mb-3">
    <input placeholder="Title" class="form-control" @bind="newTitle" />
    <input placeholder="Link(URL)" class="form-control mt-2" @bind="newUrl" />

    <!-- Category dropdown -->
    <select class="form-select mt-2" @bind="selectedCategory">
        @foreach (var cat in categories)
        {
            <option>@cat</option>
        }
    </select>

    <button class="btn btn-primary mt-2" @onclick="AddLink">Add</button>
</div>

<!-- Add new category form -->
<div class="mt-3">
    <input class="form-control" placeholder="Add Category" @bind="newCategory" />
    <button class="btn btn-secondary mt-1" @onclick="AddCategory">Add Category</button>
</div>

<!-- Search/filter component: filter by keyword and category -->
<SearchAndFilter 
    @bind-SearchKeyword="searchKeyword" 
    @bind-FilterCategory="filterCategory"
    Categories="categories" />

<!-- Link list component: shows filtered bookmarks -->
<LinkList 
    Links="links" 
    Categories="categories" 
    SearchKeyword=@searchKeyword
    FilterCategory=@filterCategory
    CurrentUserId=@currentUserId
    OnDelete=@(link => RemoveLink(link)) />

@code {
    // List of all bookmarks
    List<LinkItem> links = new();

    // Input form binding variables
    string newTitle = "";
    string newUrl = "";
    string selectedCategory = "Development";
    string newCategory = "";

    // Search/filter variables
    string searchKeyword = "";
    string filterCategory = "All";

    // Current logged-in user ID
    string currentUserId = "anonymous";

    // On page initialization: get logged-in user info
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            currentUserId = user.Identity.Name;
        }
    }

    // Initial category list
    List<string> categories = new() { "Development", "Design", "General", "IT School", "Recruitment", "Other" };

    // Add a new bookmark
    void AddLink()
    {
        Console.WriteLine($"🔽 AddLink() called by: {currentUserId}");

        if (!string.IsNullOrWhiteSpace(newTitle) && !string.IsNullOrWhiteSpace(newUrl))
        {
            links.Add(new LinkItem { Title = newTitle, Url = newUrl, 
            Category = selectedCategory,
            UserId = currentUserId });

            // Reset input fields
            newTitle = "";
            newUrl = "";

            StateHasChanged();
        }
    }

    // Add a new category
    void AddCategory()
    {
        if (!string.IsNullOrWhiteSpace(newCategory) && !categories.Contains(newCategory))
        {
            categories.Add(newCategory);
            newCategory = "";
        }
    }

    // Remove a bookmark
    void RemoveLink(LinkItem link)
    {
        links.Remove(link);
    }
}
